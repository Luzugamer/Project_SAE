{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invitar Estudiantes</title>
    {% include 'foro/estilos.html' %}
</head>
<body>
    <a href="{% url 'comunidad:principio' %}" class="back-button">
        ‚Üê Volver al Inicio
    </a>

    <div class="container">
        <div class="header">
            <div class="community-info">
                <div class="community-icon">
                    üåü
                </div>
                <div class="community-details">
                    <h1>Crear Nueva Comunidad</h1>
                    <div class="community-meta">
                        <div class="meta-item">
                            üë®‚Äçüè´ Modo Profesor
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section">
            {% if messages %}
                {% for message in messages %}
                    <div class="{% if message.tags == 'error' %}error-message{% else %}success-message{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="comunidadForm">
                {% csrf_token %}
                
                <div class="form-container">
                    <h2 class="section-title">üìù Informaci√≥n de la Comunidad</h2>
                    
                    <div class="form-group">
                        <label for="nombre" class="form-label">Nombre de la Comunidad *</label>
                        <input type="text" id="nombre" name="nombre" class="form-input" 
                               placeholder="Ej: Matem√°ticas Avanzadas 2024" required
                               oninput="actualizarVistaPrevia()">
                    </div>

                    <div class="form-group">
                        <label for="descripcion" class="form-label">Descripci√≥n *</label>
                        <textarea id="descripcion" name="descripcion" class="form-textarea" 
                                placeholder="Describe el prop√≥sito y objetivos de tu comunidad..." required
                                oninput="actualizarVistaPrevia()"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="institucion_afiliada" class="form-label">Instituci√≥n Afiliada</label>
                        <input type="text" id="institucion_afiliada" name="institucion_afiliada" class="form-input" 
                               placeholder="Ej: Universidad Nacional de Lima"
                               oninput="actualizarVistaPrevia()">
                    </div>

                    <div class="form-group">
                        <label for="icono" class="form-label">Icono de la Comunidad</label>
                        <div class="file-input-wrapper">
                            <div class="file-input">
                                <input type="file" id="icono" name="icono" accept="image/*" onchange="manejarArchivo(this)">
                                <div id="file-text">üì∏ Haz clic para seleccionar una imagen</div>
                            </div>
                        </div>
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Formatos soportados: JPG, PNG, GIF. Tama√±o m√°ximo: 5MB
                        </small>
                    </div>
                </div>

                <div class="preview-section">
                    <h2 class="section-title">üëÄ Vista Previa</h2>
                    <div class="preview-card">
                        <div class="preview-header">
                            <div class="preview-icon" id="preview-icon">
                                üè´
                            </div>
                            <div>
                                <div class="preview-title" id="preview-nombre">Nombre de la Comunidad</div>
                                <div class="preview-institution" id="preview-institucion">Sin instituci√≥n especificada</div>
                            </div>
                        </div>
                        <div class="preview-description" id="preview-descripcion">
                            La descripci√≥n de tu comunidad aparecer√° aqu√≠...
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        üöÄ Crear Comunidad
                    </button>
                    <a href="{% url 'comunidad:principio' %}" class="btn-secondary">
                        ‚ùå Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        let archivoSeleccionado = null;

        function actualizarVistaPrevia() {
            const nombre = document.getElementById('nombre').value || 'Nombre de la Comunidad';
            const descripcion = document.getElementById('descripcion').value || 'La descripci√≥n de tu comunidad aparecer√° aqu√≠...';
            const institucion = document.getElementById('institucion_afiliada').value || 'Sin instituci√≥n especificada';

            document.getElementById('preview-nombre').textContent = nombre;
            document.getElementById('preview-descripcion').textContent = descripcion;
            document.getElementById('preview-institucion').textContent = institucion;
        }

        function manejarArchivo(input) {
            const file = input.files[0];
            const fileText = document.getElementById('file-text');
            const previewIcon = document.getElementById('preview-icon');

            if (file) {
                // Validar tipo de archivo
                const tiposPermitidos = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                if (!tiposPermitidos.includes(file.type)) {
                    alert('Por favor selecciona un archivo de imagen v√°lido (JPG, PNG, GIF)');
                    input.value = '';
                    return;
                }

                // Validar tama√±o (5MB m√°ximo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('El archivo es demasiado grande. El tama√±o m√°ximo es 5MB.');
                    input.value = '';
                    return;
                }

                fileText.innerHTML = `‚úÖ ${file.name}`;
                archivoSeleccionado = file;

                // Mostrar vista previa de la imagen
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewIcon.innerHTML = `<img src="${e.target.result}" alt="Vista previa">`;
                };
                reader.readAsDataURL(file);
            } else {
                fileText.innerHTML = 'üì∏ Haz clic para seleccionar una imagen';
                previewIcon.innerHTML = 'üè´';
                archivoSeleccionado = null;
            }
        }

        // Validaci√≥n del formulario antes del env√≠o
        document.getElementById('comunidadForm').addEventListener('submit', function(e) {
            const nombre = document.getElementById('nombre').value.trim();
            const descripcion = document.getElementById('descripcion').value.trim();

            if (!nombre || !descripcion) {
                e.preventDefault();
                alert('Por favor completa todos los campos requeridos (marcados con *).');
                return;
            }

            if (nombre.length < 3) {
                e.preventDefault();
                alert('El nombre de la comunidad debe tener al menos 3 caracteres.');
                return;
            }

            if (descripcion.length < 10) {
                e.preventDefault();
                alert('La descripci√≥n debe tener al menos 10 caracteres.');
                return;
            }
        });

        // Inicializar vista previa
        document.addEventListener('DOMContentLoaded', function() {
            actualizarVistaPrevia();
        });

        // Prevenir p√©rdida de datos
        let formModificado = false;
        const form = document.getElementById('comunidadForm');
        form.addEventListener('input', function() {
            formModificado = true;
        });
        form.addEventListener('submit', function() {
            formModificado = false;
        });
        windows.addEventListener('beforeunload', function(e) {
            if (formModificado) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>